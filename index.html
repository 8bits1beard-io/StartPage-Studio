<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="StartPage Studio - Design branded landing pages for kiosks and curated user experiences. Visual editor with live preview and enterprise deployment.">
    <title>StartPage Studio</title>
    <style>
        :root {
            --true-blue: #0053E2;
            --true-blue-dark: #003da8;
            --spark-yellow: #FFC220;
            --spark-yellow-dark: #e6af1c;
            --white: #FFFFFF;
            --gray-100: #f8f9fa;
            --gray-200: #e9ecef;
            --gray-300: #dee2e6;
            --gray-600: #6c757d;
            --gray-800: #343a40;
            --danger: #dc3545;
            --danger-dark: #c82333;
            --focus-ring: 0 0 0 3px rgba(0, 83, 226, 0.5);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--gray-100);
            color: var(--gray-800);
            line-height: 1.6;
        }

        /* Skip link for keyboard navigation */
        .skip-link {
            position: absolute;
            top: -50px;
            left: 0;
            background: var(--spark-yellow);
            color: var(--gray-800);
            padding: 0.75rem 1.5rem;
            z-index: 1000;
            font-weight: 600;
            text-decoration: none;
            border-radius: 0 0 4px 0;
        }

        .skip-link:focus {
            top: 0;
            outline: 3px solid var(--true-blue);
            outline-offset: 2px;
        }

        header {
            background-color: var(--true-blue);
            color: var(--white);
            padding: 1.5rem 2rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        header svg {
            width: 40px;
            height: 40px;
        }

        header h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            padding: 1.5rem;
            max-width: 1600px;
            margin: 0 auto;
        }

        @media (max-width: 1200px) {
            .container {
                grid-template-columns: 1fr;
            }
        }

        .panel {
            background: var(--white);
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .panel-header {
            background: var(--gray-200);
            padding: 1rem 1.5rem;
            font-weight: 600;
            border-bottom: 1px solid var(--gray-300);
        }

        .panel-body {
            padding: 1.5rem;
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-group:last-child {
            margin-bottom: 0;
        }

        label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--gray-800);
        }

        label small {
            font-weight: 400;
            color: var(--gray-600);
        }

        input[type="text"],
        input[type="url"],
        select {
            width: 100%;
            padding: 0.625rem 0.875rem;
            border: 1px solid var(--gray-300);
            border-radius: 4px;
            font-size: 1rem;
            transition: border-color 0.2s, box-shadow 0.2s;
            background-color: var(--white);
        }

        input[type="text"]:focus,
        input[type="url"]:focus,
        select:focus {
            outline: none;
            border-color: var(--true-blue);
            box-shadow: var(--focus-ring);
        }

        input[type="text"]:focus-visible,
        input[type="url"]:focus-visible,
        select:focus-visible {
            outline: 3px solid var(--true-blue);
            outline-offset: 1px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--true-blue);
        }

        .checkbox-group input[type="checkbox"]:focus-visible {
            outline: 3px solid var(--true-blue);
            outline-offset: 2px;
        }

        .checkbox-group label {
            margin-bottom: 0;
            cursor: pointer;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.625rem 1.25rem;
            font-size: 0.9375rem;
            font-weight: 500;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn:focus-visible {
            outline: 3px solid var(--true-blue);
            outline-offset: 2px;
        }

        .btn-primary {
            background-color: var(--true-blue);
            color: var(--white);
        }

        .btn-primary:hover {
            background-color: var(--true-blue-dark);
        }

        .btn-primary:focus-visible {
            outline-color: var(--spark-yellow);
        }

        .btn-secondary {
            background-color: var(--gray-200);
            color: var(--gray-800);
        }

        .btn-secondary:hover {
            background-color: var(--gray-300);
        }

        .btn-danger {
            background-color: var(--danger);
            color: var(--white);
        }

        .btn-danger:hover {
            background-color: var(--danger-dark);
        }

        .btn-danger:focus-visible {
            outline-color: var(--danger);
        }

        .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
            min-height: 36px;
            min-width: 36px;
        }

        .btn-generate {
            background-color: var(--spark-yellow);
            color: var(--gray-800);
            font-weight: 600;
            padding: 0.875rem 2rem;
            font-size: 1rem;
            min-height: 44px;
        }

        .btn-generate:hover {
            background-color: var(--spark-yellow-dark);
        }

        .btn-generate:focus-visible {
            outline-color: var(--true-blue);
        }

        /* Reduced motion preference */
        @media (prefers-reduced-motion: reduce) {
            .btn,
            input[type="text"],
            input[type="url"] {
                transition: none;
            }
        }

        /* High contrast mode support */
        @media (prefers-contrast: high) {
            .btn {
                border: 2px solid currentColor;
            }

            input[type="text"],
            input[type="url"] {
                border-width: 2px;
            }
        }

        /* Visually hidden but accessible to screen readers */
        .visually-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Groups Section */
        .groups-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .group-card {
            border: 1px solid var(--gray-300);
            border-radius: 6px;
            overflow: hidden;
            padding: 0;
            margin: 0;
        }

        .group-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            background: var(--gray-100);
            border-bottom: 1px solid var(--gray-300);
        }

        .group-header input {
            flex: 1;
            font-weight: 500;
        }

        .group-icon-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--gray-50, #f9fafb);
            border-bottom: 1px solid var(--gray-300);
            font-size: 0.875rem;
        }

        .group-icon-label {
            font-weight: 500;
            color: var(--gray-600);
            margin-bottom: 0;
            white-space: nowrap;
        }

        .group-icon-row input[type="url"] {
            flex: 1;
            padding: 0.375rem 0.5rem;
            font-size: 0.875rem;
        }

        .group-icon-row .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }

        .group-links {
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .link-row {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .link-row input {
            flex: 1;
            min-width: 120px;
        }

        .link-row input:first-of-type {
            max-width: 35%;
        }

        .link-row select.windows-app-select {
            width: auto;
            min-width: 140px;
            flex: 0 0 auto;
            font-size: 0.875rem;
            padding: 0.5rem;
            background-color: #e7f1ff;
            border: 1px solid var(--true-blue);
            border-radius: 4px;
            color: var(--true-blue);
            font-weight: 500;
            cursor: pointer;
        }

        .link-row select.windows-app-select:hover {
            background-color: #d0e3ff;
        }

        .link-row select.windows-app-select:focus {
            outline: none;
            box-shadow: var(--focus-ring);
        }

        /* Drag and drop styles */
        .drag-handle {
            cursor: grab;
            padding: 0.25rem;
            color: var(--gray-600);
            font-size: 1rem;
            user-select: none;
            display: flex;
            align-items: center;
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        .group-card.dragging,
        .link-row.dragging {
            opacity: 0.5;
            background: var(--gray-200);
        }

        .group-card.drag-over {
            border: 2px dashed var(--true-blue);
            background: #e7f1ff;
        }

        .link-row.drag-over {
            border-top: 2px solid var(--true-blue);
        }

        /* Collapsible sections */
        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            padding: 0.5rem 0;
            user-select: none;
        }

        .section-header:hover {
            opacity: 0.8;
        }

        .section-header h3,
        .section-header legend {
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .collapse-icon {
            font-size: 0.75rem;
            transition: transform 0.2s ease;
            color: var(--gray-600);
        }

        .section-header.collapsed .collapse-icon {
            transform: rotate(-90deg);
        }

        .section-content {
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.2s ease;
            max-height: 2000px;
            opacity: 1;
        }

        .section-content.collapsed {
            max-height: 0;
            opacity: 0;
            padding: 0;
            margin: 0;
        }

        @media (prefers-reduced-motion: reduce) {
            .collapse-icon,
            .section-content {
                transition: none;
            }
        }

        /* Input validation */
        input.invalid {
            border-color: var(--danger);
            background-color: #fff5f5;
        }

        input.invalid:focus {
            box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.3);
        }

        .validation-error {
            color: var(--danger);
            font-size: 0.75rem;
            margin-top: 0.25rem;
            display: none;
        }

        .validation-error.visible {
            display: block;
        }

        .empty-message {
            color: var(--gray-600);
            font-style: italic;
            text-align: center;
            padding: 1rem;
        }

        .actions-bar {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        /* Preview Section */
        .preview-container {
            position: sticky;
            top: 1.5rem;
        }

        .preview-frame {
            background: var(--true-blue);
            border-radius: 6px;
            min-height: 500px;
            overflow: hidden;
        }

        .preview-frame iframe {
            width: 100%;
            height: 600px;
            border: none;
        }

        /* Output Section */
        .output-section {
            margin-top: 1.5rem;
        }

        .output-actions {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            justify-content: center;
            padding: 1rem;
        }

        /* Info text */
        .info-text {
            background: #e7f1ff;
            border: 1px solid #b6d4fe;
            border-radius: 4px;
            padding: 0.75rem 1rem;
            font-size: 0.875rem;
            color: #084298;
            margin-bottom: 1rem;
        }

        /* Scrollable editor */
        .editor-scroll {
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }

        footer {
            text-align: center;
            padding: 1.5rem;
            color: var(--gray-600);
            font-size: 0.875rem;
        }

        /* Theme swatches */
        .theme-swatches {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .theme-swatch {
            width: 50px;
            height: 50px;
            border-radius: 6px;
            cursor: pointer;
            border: 3px solid var(--gray-300);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .theme-swatch:hover {
            border-color: var(--gray-600);
        }

        .theme-swatch.selected {
            border-color: var(--true-blue);
            box-shadow: var(--focus-ring);
        }

        .theme-swatch:focus-visible {
            outline: 3px solid var(--true-blue);
            outline-offset: 2px;
        }

        .theme-swatch .swatch-primary,
        .theme-swatch .swatch-accent {
            flex: 1;
        }

        .theme-swatch-custom {
            background: linear-gradient(135deg, #ff6b6b 0%, #feca57 25%, #48dbfb 50%, #ff9ff3 75%, #54a0ff 100%);
            position: relative;
        }

        .theme-swatch-custom::after {
            content: '+';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.5rem;
            font-weight: bold;
            color: white;
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
        }

        .swatch-label {
            font-size: 0.75rem;
            color: var(--gray-600);
            text-align: center;
            margin-top: 0.25rem;
        }

        .swatch-container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Custom colors section */
        .custom-colors {
            display: none;
            gap: 1rem;
            flex-wrap: wrap;
            padding: 1rem;
            background: var(--gray-100);
            border-radius: 6px;
            margin-top: 0.5rem;
        }

        .custom-colors.visible {
            display: flex;
        }

        .color-input-group {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .color-input-group label {
            font-size: 0.875rem;
            margin-bottom: 0;
        }

        .color-input-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .color-input-row input[type="color"] {
            width: 40px;
            height: 40px;
            padding: 0;
            border: 1px solid var(--gray-300);
            border-radius: 4px;
            cursor: pointer;
        }

        .color-input-row input[type="text"] {
            width: 90px;
            font-family: monospace;
        }

        /* Logo input row */
        .logo-input-row {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .logo-input-row input[type="url"] {
            flex: 1;
        }

        .logo-input-row .upload-btn {
            cursor: pointer;
            white-space: nowrap;
        }

        .logo-input-row .btn-sm:last-child {
            padding: 0.375rem 0.5rem;
            font-size: 0.75rem;
            background: var(--gray-100);
            color: var(--gray-600);
        }

        .logo-input-row .btn-sm:last-child:hover {
            background: var(--gray-200);
            color: var(--gray-800);
        }

        .custom-warning {
            display: none;
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 4px;
            padding: 0.75rem 1rem;
            font-size: 0.875rem;
            color: #856404;
            margin-top: 0.5rem;
        }

        .custom-warning.visible {
            display: block;
        }

        @media (prefers-reduced-motion: reduce) {
            .theme-swatch {
                transition: none;
            }
        }

        /* Instruction modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.visible {
            display: flex;
        }

        .modal {
            background: var(--white);
            border-radius: 8px;
            max-width: 550px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            background: var(--true-blue);
            color: var(--white);
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.25rem;
        }

        .modal-close {
            background: transparent;
            border: none;
            color: var(--white);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.25rem;
            line-height: 1;
        }

        .modal-close:hover {
            opacity: 0.8;
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-body h3 {
            color: var(--true-blue);
            margin-bottom: 0.75rem;
            font-size: 1rem;
        }

        .modal-body p {
            margin-bottom: 1rem;
            line-height: 1.6;
        }

        .modal-body ol {
            margin: 0 0 1rem 1.25rem;
            line-height: 1.8;
        }

        .modal-body code {
            background: var(--gray-200);
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.875rem;
            word-break: break-all;
        }

        .modal-body .code-block {
            background: var(--gray-800);
            color: var(--spark-yellow);
            padding: 0.75rem 1rem;
            border-radius: 4px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.85rem;
            overflow-x: auto;
            margin: 0.5rem 0 1rem;
        }

        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--gray-300);
            display: flex;
            justify-content: flex-end;
        }
    </style>
</head>
<body>
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <header role="banner">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="StartPage Studio logo">
            <rect x="3" y="3" width="7" height="7" rx="1.5" fill="#FFC220"/>
            <rect x="14" y="3" width="7" height="7" rx="1.5" fill="#FFC220"/>
            <rect x="3" y="14" width="7" height="7" rx="1.5" fill="#FFC220"/>
            <rect x="14" y="14" width="7" height="7" rx="1.5" fill="#FFC220"/>
        </svg>
        <h1>StartPage Studio</h1>
    </header>

    <main id="main-content" class="container" role="main">
        <!-- Editor Panel -->
        <section class="panel" aria-labelledby="config-heading">
            <h2 id="config-heading" class="panel-header">Configuration</h2>
            <div class="panel-body editor-scroll">
                <!-- Page Settings -->
                <fieldset style="border: none; padding: 0; margin: 0;">
                    <div class="section-header" id="page-settings-header" onclick="toggleSection('page-settings')" aria-expanded="true" aria-controls="page-settings-content" role="button" tabindex="0" onkeydown="if(event.key==='Enter')toggleSection('page-settings')">
                        <legend style="color: var(--true-blue); font-size: 1.17em; font-weight: bold; cursor: pointer;">
                            <span class="collapse-icon">▼</span> Page Settings
                        </legend>
                    </div>
                    <div class="section-content" id="page-settings-content">
                    <div class="form-group">
                        <label for="pageTitle">Page Title <small>(browser tab)</small></label>
                        <input type="text" id="pageTitle" value="Quick Links" oninput="updatePreview()">
                    </div>

                    <div class="form-group">
                        <label for="greeting">Greeting Text</label>
                        <input type="text" id="greeting" value="Welcome" oninput="updatePreview()">
                    </div>

                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" id="showComputerName" checked onchange="updatePreview()">
                            <label for="showComputerName">Show computer name</label>
                        </div>
                    </div>

                    <div class="form-group" id="computerNamePositionGroup">
                        <label for="computerNamePosition">Computer name position</label>
                        <select id="computerNamePosition" onchange="updatePreview(); updateDateTimePositionOptions();">
                            <option value="top-right" selected>Top Right</option>
                            <option value="top-center">Top Center</option>
                            <option value="top-left">Top Left</option>
                            <option value="bottom-right">Bottom Right</option>
                            <option value="bottom-center">Bottom Center</option>
                            <option value="bottom-left">Bottom Left</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" id="showDateTime" onchange="updatePreview()">
                            <label for="showDateTime">Show date/time <small>(ISO 8601)</small></label>
                        </div>
                    </div>

                    <div class="form-group" id="dateTimeOptionsGroup" style="display: none;">
                        <label for="dateTimeFormat">Display format</label>
                        <select id="dateTimeFormat" onchange="updatePreview()">
                            <option value="both" selected>Date and Time</option>
                            <option value="date">Date only</option>
                            <option value="time">Time only</option>
                        </select>
                    </div>

                    <div class="form-group" id="dateTimePositionGroup" style="display: none;">
                        <label for="dateTimePosition">Date/time position</label>
                        <select id="dateTimePosition" onchange="updatePreview()">
                            <option value="top-left">Top Left</option>
                            <option value="top-center">Top Center</option>
                            <option value="bottom-right">Bottom Right</option>
                            <option value="bottom-center">Bottom Center</option>
                            <option value="bottom-left">Bottom Left</option>
                            <option value="footer">In Footer</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="topLogoUrl">Top Logo <small>(above greeting text)</small></label>
                        <div class="logo-input-row">
                            <input type="url" id="topLogoUrl" value="" placeholder="https://example.com/logo.png" oninput="updatePreview()">
                            <label for="topLogoUpload" class="btn btn-secondary btn-sm upload-btn">
                                Upload SVG
                                <input type="file" id="topLogoUpload" accept=".svg,image/svg+xml" onchange="handleLogoUpload('top', this)" class="visually-hidden">
                            </label>
                            <button type="button" class="btn btn-sm" onclick="clearLogo('top')" aria-label="Clear top logo" title="Clear">✕</button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="sideLogoUrl">Side Logo <small>(beside greeting text)</small></label>
                        <div class="logo-input-row">
                            <input type="url" id="sideLogoUrl" value="" placeholder="https://example.com/logo.png" oninput="updatePreview()">
                            <label for="sideLogoUpload" class="btn btn-secondary btn-sm upload-btn">
                                Upload SVG
                                <input type="file" id="sideLogoUpload" accept=".svg,image/svg+xml" onchange="handleLogoUpload('side', this)" class="visually-hidden">
                            </label>
                            <button type="button" class="btn btn-sm" onclick="clearLogo('side')" aria-label="Clear side logo" title="Clear">✕</button>
                        </div>
                    </div>

                    <div class="form-group" id="sideLogoPositionGroup" style="display: none;">
                        <label for="sideLogoPosition">Side logo position</label>
                        <select id="sideLogoPosition" onchange="updatePreview()">
                            <option value="left" selected>Left of greeting</option>
                            <option value="right">Right of greeting</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" id="showFooter" checked onchange="updatePreview()">
                            <label for="showFooter">Show footer</label>
                        </div>
                    </div>

                    <div class="form-group" id="footerTextGroup">
                        <label for="footerText">Footer Text</label>
                        <input type="text" id="footerText" value="" oninput="updatePreview()">
                    </div>

                    <div class="form-group">
                        <label for="destinationPath">Destination Path <small>(where landing page will be saved)</small></label>
                        <input type="text" id="destinationPath" value="C:\ProgramData\StartPage\index.html" placeholder="C:\ProgramData\StartPage\index.html">
                    </div>
                    </div>
                </fieldset>

                <hr style="margin: 1.5rem 0; border: none; border-top: 1px solid var(--gray-300);">

                <!-- Color Theme -->
                <section aria-labelledby="theme-heading">
                    <div class="section-header collapsed" id="color-theme-header" onclick="toggleSection('color-theme')" aria-expanded="false" aria-controls="color-theme-content" role="button" tabindex="0" onkeydown="if(event.key==='Enter')toggleSection('color-theme')">
                        <h3 id="theme-heading" style="color: var(--true-blue); cursor: pointer;">
                            <span class="collapse-icon">▼</span> Color Theme
                        </h3>
                    </div>
                    <div class="section-content collapsed" id="color-theme-content">
                    <p id="theme-description" style="color: var(--gray-600); font-size: 0.875rem; margin-bottom: 1rem;">
                        Choose a color theme for your landing page.
                    </p>

                    <div class="theme-swatches" role="radiogroup" aria-labelledby="theme-heading" id="themeSwatches">
                        <!-- Swatches will be rendered by JavaScript -->
                    </div>

                    <div id="customColors" class="custom-colors">
                        <div class="color-input-group">
                            <label for="customPrimary">Primary Color</label>
                            <div class="color-input-row">
                                <input type="color" id="customPrimaryPicker" value="#0053E2" onchange="syncColorInput('primary', this.value)">
                                <input type="text" id="customPrimary" value="#0053E2" placeholder="#000000" oninput="syncColorPicker('primary', this.value)">
                            </div>
                        </div>
                        <div class="color-input-group">
                            <label for="customAccent">Accent Color</label>
                            <div class="color-input-row">
                                <input type="color" id="customAccentPicker" value="#FFC220" onchange="syncColorInput('accent', this.value)">
                                <input type="text" id="customAccent" value="#FFC220" placeholder="#000000" oninput="syncColorPicker('accent', this.value)">
                            </div>
                        </div>
                    </div>

                    <div id="customWarning" class="custom-warning">
                        Custom colors may not meet WCAG accessibility standards. Ensure sufficient contrast between background and text colors.
                    </div>
                    </div>
                </section>

                <hr style="margin: 1.5rem 0; border: none; border-top: 1px solid var(--gray-300);">

                <!-- Link Groups -->
                <section aria-labelledby="groups-heading">
                    <div class="section-header" id="link-groups-header" onclick="toggleSection('link-groups')" aria-expanded="true" aria-controls="link-groups-content" role="button" tabindex="0" onkeydown="if(event.key==='Enter')toggleSection('link-groups')">
                        <h3 id="groups-heading" style="color: var(--true-blue); cursor: pointer;">
                            <span class="collapse-icon">▼</span> Link Groups
                        </h3>
                    </div>
                    <div class="section-content" id="link-groups-content">
                    <p id="groups-description" style="color: var(--gray-600); font-size: 0.875rem; margin-bottom: 1rem;">
                        Organize links into groups, or add ungrouped links below.
                    </p>

                    <div id="groupsContainer" class="groups-container" role="region" aria-labelledby="groups-heading" aria-describedby="groups-description" aria-live="polite">
                        <!-- Groups will be added here dynamically -->
                    </div>

                    <div class="actions-bar">
                        <button type="button" class="btn btn-primary" onclick="addGroup()" aria-describedby="groups-description">
                            + Add Group
                        </button>
                    </div>
                    </div>
                </section>

                <hr style="margin: 1.5rem 0; border: none; border-top: 1px solid var(--gray-300);">

                <!-- Ungrouped Links -->
                <section aria-labelledby="ungrouped-heading">
                    <div class="section-header collapsed" id="ungrouped-links-header" onclick="toggleSection('ungrouped-links')" aria-expanded="false" aria-controls="ungrouped-links-content" role="button" tabindex="0" onkeydown="if(event.key==='Enter')toggleSection('ungrouped-links')">
                        <h3 id="ungrouped-heading" style="color: var(--true-blue); cursor: pointer;">
                            <span class="collapse-icon">▼</span> Ungrouped Links
                        </h3>
                    </div>
                    <div class="section-content collapsed" id="ungrouped-links-content">
                    <p id="ungrouped-description" style="color: var(--gray-600); font-size: 0.875rem; margin-bottom: 1rem;">
                        Links here will appear without a group heading.
                    </p>

                    <div id="ungroupedLinksContainer" role="region" aria-labelledby="ungrouped-heading" aria-live="polite">
                        <!-- Ungrouped links will be added here -->
                    </div>

                    <div class="actions-bar">
                        <button type="button" class="btn btn-secondary" onclick="addUngroupedLink()" aria-describedby="ungrouped-description">
                            + Add Link
                        </button>
                    </div>
                    </div>
                </section>

                <hr style="margin: 1.5rem 0; border: none; border-top: 1px solid var(--gray-300);">

                <!-- Generate Section -->
                <section class="output-section" aria-labelledby="output-heading">
                    <h3 id="output-heading" class="visually-hidden">Download Options</h3>
                    <div class="output-actions" style="flex-direction: column; align-items: center;">
                        <button type="button" class="btn btn-generate" onclick="downloadScript()">
                            Download PowerShell Script (Recommended)
                        </button>
                        <p style="font-size: 0.75rem; color: var(--gray-600); margin: 0.5rem 0;">
                            Captures computer name at runtime. Deploy via Intune/SCCM.
                        </p>
                        <button type="button" class="btn btn-secondary btn-sm" onclick="downloadHTML()" style="margin-top: 0.5rem;">
                            Download HTML Only
                        </button>
                        <p style="font-size: 0.75rem; color: var(--gray-600); margin: 0.25rem 0 0 0;">
                            For testing. Computer name shows as placeholder.
                        </p>
                        <hr style="width: 100%; margin: 1rem 0; border: none; border-top: 1px solid var(--gray-300);">
                        <label for="importFile" class="btn btn-secondary btn-sm" style="cursor: pointer;">
                            Import Existing Start Page
                            <input type="file" id="importFile" accept=".html,text/html" onchange="importStartPage(this)" class="visually-hidden">
                        </label>
                        <p style="font-size: 0.75rem; color: var(--gray-600); margin: 0.25rem 0 0 0;">
                            Load a previously generated start page to edit.
                        </p>
                    </div>
                </section>
            </div>
        </section>

        <!-- Preview Panel -->
        <section class="panel preview-container" aria-labelledby="preview-heading">
            <h2 id="preview-heading" class="panel-header">Live Preview</h2>
            <div class="preview-frame">
                <iframe id="previewFrame" title="Landing page preview"></iframe>
            </div>
        </section>
    </main>

    <footer role="contentinfo">
        <p>StartPage Studio | Author: Joshua Walderbach</p>
    </footer>

    <!-- Screen reader announcements -->
    <div id="sr-announcements" class="visually-hidden" role="status" aria-live="polite" aria-atomic="true"></div>

    <!-- Instruction modal -->
    <div id="instructionModal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="modal-title">
        <div class="modal">
            <div class="modal-header">
                <h2 id="modal-title">PowerShell Script Downloaded</h2>
                <button type="button" class="modal-close" onclick="closeModal()" aria-label="Close">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Content will be populated by JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="closeModal()">Got it</button>
            </div>
        </div>
    </div>

    <script>
        // State management
        let groups = [];
        let ungroupedLinks = [];
        let groupIdCounter = 0;
        let linkIdCounter = 0;


        // Windows app URI schemes
        const windowsApps = [
            { category: 'System Settings', name: 'Settings Home', uri: 'ms-settings:' },
            { category: 'System Settings', name: 'Display', uri: 'ms-settings:display' },
            { category: 'System Settings', name: 'Network & Internet', uri: 'ms-settings:network' },
            { category: 'System Settings', name: 'Wi-Fi', uri: 'ms-settings:network-wifi' },
            { category: 'System Settings', name: 'Bluetooth', uri: 'ms-settings:bluetooth' },
            { category: 'System Settings', name: 'Printers & Scanners', uri: 'ms-settings:printers' },
            { category: 'System Settings', name: 'Sound', uri: 'ms-settings:sound' },
            { category: 'System Settings', name: 'Default Apps', uri: 'ms-settings:defaultapps' },
            { category: 'System Settings', name: 'Storage', uri: 'ms-settings:storagesense' },
            { category: 'System Settings', name: 'Windows Update', uri: 'ms-settings:windowsupdate' },
            { category: 'System Settings', name: 'Privacy', uri: 'ms-settings:privacy' },
            { category: 'System Settings', name: 'About / System Info', uri: 'ms-settings:about' },
            { category: 'System Settings', name: 'VPN', uri: 'ms-settings:network-vpn' },
            { category: 'System Settings', name: 'Proxy', uri: 'ms-settings:network-proxy' },
            { category: 'Built-in Apps', name: 'Calculator', uri: 'calculator:' },
            { category: 'Built-in Apps', name: 'Clock / Alarms', uri: 'ms-clock:' },
            { category: 'Built-in Apps', name: 'Photos', uri: 'ms-photos:' },
            { category: 'Built-in Apps', name: 'Paint', uri: 'ms-paint:' },
            { category: 'Built-in Apps', name: 'Snipping Tool', uri: 'ms-screenclip:' },
            { category: 'Built-in Apps', name: 'Snip & Sketch', uri: 'ms-screensketch:' },
            { category: 'Built-in Apps', name: 'Microsoft To Do', uri: 'ms-todo:' },
            { category: 'Built-in Apps', name: 'Weather', uri: 'msnweather:' },
            { category: 'Built-in Apps', name: 'Maps', uri: 'bingmaps:' },
            { category: 'Built-in Apps', name: 'Xbox', uri: 'xbox:' },
            { category: 'Built-in Apps', name: 'Microsoft Store', uri: 'ms-windows-store:' },
            { category: 'Built-in Apps', name: 'Feedback Hub', uri: 'feedback-hub:' },
            { category: 'Built-in Apps', name: 'Tips / Get Started', uri: 'ms-get-started:' },
            { category: 'Microsoft 365', name: 'Outlook', uri: 'ms-outlook:' },
            { category: 'Microsoft 365', name: 'Microsoft Teams', uri: 'msteams:' },
            { category: 'Microsoft 365', name: 'Teams Chat', uri: 'ms-chat:' },
            { category: 'Network', name: 'Wi-Fi Networks', uri: 'ms-availablenetworks:' },
            { category: 'Browser', name: 'Microsoft Edge', uri: 'microsoft-edge:' },
        ];

        // Theme presets (all WCAG AA verified)
        const themes = {
            walmart: { name: 'Walmart', primary: '#0053E2', accent: '#FFC220' },
            sunset: { name: 'Sunset', primary: '#9a3412', accent: '#fbbf24' },
            violet: { name: 'Violet', primary: '#5b21b6', accent: '#c4b5fd' },
            slate: { name: 'Slate', primary: '#1e293b', accent: '#f59e0b' },
            forest: { name: 'Forest', primary: '#166534', accent: '#fbbf24' },
            ocean: { name: 'Ocean', primary: '#0369a1', accent: '#06b6d4' },
            crimson: { name: 'Crimson', primary: '#991b1b', accent: '#fbbf24' },
            monochrome: { name: 'Monochrome', primary: '#171717', accent: '#a3a3a3' }
        };
        let selectedTheme = 'monochrome';
        let customColors = { primary: '#0053E2', accent: '#FFC220' };

        // Get active colors based on selected theme
        function getActiveColors() {
            if (selectedTheme === 'custom') {
                return customColors;
            }
            return themes[selectedTheme];
        }

        // Render theme swatches
        function renderThemeSwatches() {
            const container = document.getElementById('themeSwatches');
            let html = '';

            // Render preset theme swatches
            for (const [key, theme] of Object.entries(themes)) {
                const isSelected = selectedTheme === key;
                html += `
                    <div class="swatch-container">
                        <button type="button"
                                class="theme-swatch ${isSelected ? 'selected' : ''}"
                                onclick="selectTheme('${key}')"
                                role="radio"
                                aria-checked="${isSelected}"
                                aria-label="${theme.name} theme"
                                title="${theme.name}">
                            <div class="swatch-primary" style="background-color: ${theme.primary};"></div>
                            <div class="swatch-accent" style="background-color: ${theme.accent};"></div>
                        </button>
                        <span class="swatch-label">${theme.name}</span>
                    </div>
                `;
            }

            // Add custom swatch
            const isCustomSelected = selectedTheme === 'custom';
            html += `
                <div class="swatch-container">
                    <button type="button"
                            class="theme-swatch theme-swatch-custom ${isCustomSelected ? 'selected' : ''}"
                            onclick="selectTheme('custom')"
                            role="radio"
                            aria-checked="${isCustomSelected}"
                            aria-label="Custom theme"
                            title="Custom colors">
                    </button>
                    <span class="swatch-label">Custom</span>
                </div>
            `;

            container.innerHTML = html;

            // Show/hide custom colors section
            const customColorsSection = document.getElementById('customColors');
            const customWarning = document.getElementById('customWarning');
            if (isCustomSelected) {
                customColorsSection.classList.add('visible');
                customWarning.classList.add('visible');
            } else {
                customColorsSection.classList.remove('visible');
                customWarning.classList.remove('visible');
            }
        }

        // Select a theme
        function selectTheme(themeKey) {
            selectedTheme = themeKey;
            renderThemeSwatches();
            updatePreview();
            const themeName = themeKey === 'custom' ? 'Custom' : themes[themeKey].name;
            announce(`${themeName} theme selected`);
        }

        // Sync color input from color picker
        function syncColorInput(colorType, value) {
            customColors[colorType] = value;
            document.getElementById(`custom${colorType.charAt(0).toUpperCase() + colorType.slice(1)}`).value = value;
            updatePreview();
        }

        // Sync color picker from text input
        function syncColorPicker(colorType, value) {
            // Validate hex color
            if (/^#[0-9A-Fa-f]{6}$/.test(value)) {
                customColors[colorType] = value;
                document.getElementById(`custom${colorType.charAt(0).toUpperCase() + colorType.slice(1)}Picker`).value = value;
                updatePreview();
            }
        }

        // Handle logo SVG file upload
        function handleLogoUpload(logoType, input) {
            const file = input.files[0];
            if (!file) return;

            if (!file.type.includes('svg')) {
                alert('Please upload an SVG file.');
                input.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const svgContent = e.target.result;
                const dataUri = 'data:image/svg+xml,' + encodeURIComponent(svgContent);
                const inputId = logoType === 'top' ? 'topLogoUrl' : 'sideLogoUrl';
                document.getElementById(inputId).value = dataUri;
                updatePreview();
                announce(`${logoType === 'top' ? 'Top' : 'Side'} logo uploaded`);
            };
            reader.readAsText(file);
            input.value = ''; // Reset file input
        }

        // Clear logo
        function clearLogo(logoType) {
            const inputId = logoType === 'top' ? 'topLogoUrl' : 'sideLogoUrl';
            document.getElementById(inputId).value = '';
            updatePreview();
            announce(`${logoType === 'top' ? 'Top' : 'Side'} logo cleared`);
        }

        // Update group icon
        function updateGroupIcon(groupId, value) {
            const group = groups.find(g => g.id === groupId);
            if (group) {
                group.icon = value;
                updatePreview();
            }
        }

        // Handle group icon SVG upload
        function handleGroupIconUpload(groupId, input) {
            const file = input.files[0];
            if (!file) return;

            if (!file.type.includes('svg')) {
                alert('Please upload an SVG file.');
                input.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const svgContent = e.target.result;
                const dataUri = 'data:image/svg+xml,' + encodeURIComponent(svgContent);
                const group = groups.find(g => g.id === groupId);
                if (group) {
                    group.icon = dataUri;
                    document.getElementById(`group-icon-${groupId}`).value = dataUri;
                    updatePreview();
                    announce('Group icon uploaded');
                }
            };
            reader.readAsText(file);
            input.value = '';
        }

        // Clear group icon
        function clearGroupIcon(groupId) {
            const group = groups.find(g => g.id === groupId);
            if (group) {
                group.icon = '';
                document.getElementById(`group-icon-${groupId}`).value = '';
                updatePreview();
                announce('Group icon cleared');
            }
        }

        // Generate Windows app dropdown options HTML
        function getWindowsAppOptionsHTML() {
            const categories = [...new Set(windowsApps.map(app => app.category))];
            let html = '<option value="">+ Quick Add App</option>';
            categories.forEach(category => {
                html += `<optgroup label="${category}">`;
                windowsApps.filter(app => app.category === category).forEach(app => {
                    html += `<option value="${app.uri}" data-name="${escapeHtml(app.name)}">${app.name}</option>`;
                });
                html += '</optgroup>';
            });
            return html;
        }

        // Handle Windows app selection for grouped links
        function selectWindowsApp(groupId, linkId, selectElement) {
            if (!selectElement.value) return;
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            const appName = selectedOption.dataset.name;
            const appUri = selectElement.value;

            // Update the link data
            const group = groups.find(g => g.id === groupId);
            if (group) {
                const link = group.links.find(l => l.id === linkId);
                if (link) {
                    link.name = appName;
                    link.url = appUri;
                }
            }

            // Update the input fields
            document.getElementById(`link-name-${groupId}-${linkId}`).value = appName;
            document.getElementById(`link-url-${groupId}-${linkId}`).value = appUri;

            // Reset the dropdown
            selectElement.value = '';

            updatePreview();
            announce(`${appName} added`);
        }

        // Handle Windows app selection for ungrouped links
        function selectWindowsAppUngrouped(linkId, selectElement) {
            if (!selectElement.value) return;
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            const appName = selectedOption.dataset.name;
            const appUri = selectElement.value;

            // Update the link data
            const link = ungroupedLinks.find(l => l.id === linkId);
            if (link) {
                link.name = appName;
                link.url = appUri;
            }

            // Update the input fields
            document.getElementById(`ungrouped-name-${linkId}`).value = appName;
            document.getElementById(`ungrouped-url-${linkId}`).value = appUri;

            // Reset the dropdown
            selectElement.value = '';

            updatePreview();
            announce(`${appName} added`);
        }

        // Announce to screen readers
        function announce(message) {
            const announcer = document.getElementById('sr-announcements');
            announcer.textContent = message;
            // Clear after announcement
            setTimeout(() => { announcer.textContent = ''; }, 1000);
        }

        // Toggle collapsible section
        function toggleSection(sectionId) {
            const header = document.getElementById(`${sectionId}-header`);
            const content = document.getElementById(`${sectionId}-content`);
            if (header && content) {
                header.classList.toggle('collapsed');
                content.classList.toggle('collapsed');
                const isCollapsed = content.classList.contains('collapsed');
                header.setAttribute('aria-expanded', !isCollapsed);
                saveState();
            }
        }

        // URL validation
        function isValidUrl(string) {
            if (!string || string.trim() === '') return true; // Empty is ok (optional)
            // Allow http, https, and Windows app URI schemes
            const urlPattern = /^(https?:\/\/|ms-|calculator:|xbox:|msteams:|bingmaps:|msnweather:|feedback-hub:).+/i;
            return urlPattern.test(string.trim());
        }

        function validateUrlInput(input) {
            const value = input.value.trim();
            if (value && !isValidUrl(value)) {
                input.classList.add('invalid');
                return false;
            } else {
                input.classList.remove('invalid');
                return true;
            }
        }

        function validateAllUrls() {
            let allValid = true;
            let invalidCount = 0;

            // Validate grouped links
            groups.forEach(group => {
                group.links.forEach(link => {
                    if (link.url && !isValidUrl(link.url)) {
                        allValid = false;
                        invalidCount++;
                        const input = document.getElementById(`link-url-${group.id}-${link.id}`);
                        if (input) input.classList.add('invalid');
                    }
                });
            });

            // Validate ungrouped links
            ungroupedLinks.forEach(link => {
                if (link.url && !isValidUrl(link.url)) {
                    allValid = false;
                    invalidCount++;
                    const input = document.getElementById(`ungrouped-url-${link.id}`);
                    if (input) input.classList.add('invalid');
                }
            });

            if (!allValid) {
                alert(`${invalidCount} invalid URL${invalidCount > 1 ? 's' : ''} found. Please fix the highlighted fields.\n\nURLs must start with http://, https://, or be a valid Windows app URI.`);
            }

            return allValid;
        }

        // localStorage key for saving state
        const STORAGE_KEY = 'startPageStudioState';

        // Save current state to localStorage
        function saveState() {
            const state = {
                groups,
                ungroupedLinks,
                groupIdCounter,
                linkIdCounter,
                selectedTheme,
                customColors,
                settings: {
                    pageTitle: document.getElementById('pageTitle').value,
                    greeting: document.getElementById('greeting').value,
                    showComputerName: document.getElementById('showComputerName').checked,
                    computerNamePosition: document.getElementById('computerNamePosition').value,
                    showDateTime: document.getElementById('showDateTime').checked,
                    dateTimeFormat: document.getElementById('dateTimeFormat').value,
                    dateTimePosition: document.getElementById('dateTimePosition').value,
                    topLogoUrl: document.getElementById('topLogoUrl').value,
                    sideLogoUrl: document.getElementById('sideLogoUrl').value,
                    sideLogoPosition: document.getElementById('sideLogoPosition').value,
                    showFooter: document.getElementById('showFooter').checked,
                    footerText: document.getElementById('footerText').value,
                    destinationPath: document.getElementById('destinationPath').value
                }
            };
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
            } catch (e) {
                console.warn('Could not save state to localStorage:', e);
            }
        }

        // Load state from localStorage
        function loadState() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    const state = JSON.parse(saved);

                    // Restore arrays and counters
                    groups = state.groups || [];
                    ungroupedLinks = state.ungroupedLinks || [];
                    groupIdCounter = state.groupIdCounter || 0;
                    linkIdCounter = state.linkIdCounter || 0;
                    selectedTheme = state.selectedTheme || 'monochrome';
                    customColors = state.customColors || { primary: '#0053E2', accent: '#FFC220' };

                    // Restore form settings
                    if (state.settings) {
                        document.getElementById('pageTitle').value = state.settings.pageTitle || 'Quick Links';
                        document.getElementById('greeting').value = state.settings.greeting || 'Welcome';
                        document.getElementById('showComputerName').checked = state.settings.showComputerName !== false;
                        document.getElementById('computerNamePosition').value = state.settings.computerNamePosition || 'top-right';
                        document.getElementById('showDateTime').checked = state.settings.showDateTime || false;
                        document.getElementById('dateTimeFormat').value = state.settings.dateTimeFormat || 'both';
                        document.getElementById('dateTimePosition').value = state.settings.dateTimePosition || 'top-left';
                        document.getElementById('topLogoUrl').value = state.settings.topLogoUrl || state.settings.headerLogoUrl || state.settings.logoUrl || '';
                        document.getElementById('sideLogoUrl').value = state.settings.sideLogoUrl || state.settings.cornerLogoUrl || '';
                        document.getElementById('sideLogoPosition').value = state.settings.sideLogoPosition || 'left';
                        document.getElementById('showFooter').checked = state.settings.showFooter !== false;
                        document.getElementById('footerText').value = state.settings.footerText || '';
                        document.getElementById('destinationPath').value = state.settings.destinationPath || 'C:\\ProgramData\\StartPage\\index.html';

                        // Restore custom color inputs if custom theme
                        if (selectedTheme === 'custom') {
                            document.getElementById('customPrimary').value = customColors.primary;
                            document.getElementById('customPrimaryPicker').value = customColors.primary;
                            document.getElementById('customAccent').value = customColors.accent;
                            document.getElementById('customAccentPicker').value = customColors.accent;
                        }
                    }
                    return true;
                }
            } catch (e) {
                console.warn('Could not load state from localStorage:', e);
            }
            return false;
        }

        // Initialize application
        function init() {
            const hasExistingState = loadState();

            renderThemeSwatches();

            if (!hasExistingState) {
                // Set defaults for new users (no logo by default)
                addGroup('Productivity', [
                    { name: 'Email', url: 'https://outlook.office.com' }
                ], true);
                addGroup('Resources', [
                    { name: 'Help Desk', url: 'https://support.example.com' }
                ], true);
            } else {
                // Render loaded state
                renderGroups();
                renderUngroupedLinks();
            }

            updatePreview();
        }

        // Add a new group
        function addGroup(name = '', links = [], silent = false) {
            const groupId = groupIdCounter++;
            const groupName = name || 'New Group';
            const group = {
                id: groupId,
                name: groupName,
                links: links.length ? links.map(l => ({ ...l, id: linkIdCounter++ })) : []
            };
            groups.push(group);
            renderGroups();
            updatePreview();
            if (!silent) {
                announce(`Group "${groupName}" added`);
            }
        }

        // Remove a group
        function removeGroup(groupId) {
            const group = groups.find(g => g.id === groupId);
            const groupName = group ? group.name : 'Group';
            const linkCount = group ? group.links.length : 0;
            const message = linkCount > 0
                ? `Delete "${groupName}" and its ${linkCount} link${linkCount === 1 ? '' : 's'}?`
                : `Delete "${groupName}"?`;
            if (!confirm(message)) return;
            groups = groups.filter(g => g.id !== groupId);
            renderGroups();
            updatePreview();
            announce(`Group "${groupName}" removed`);
        }

        // Add a link to a group
        function addLinkToGroup(groupId) {
            const group = groups.find(g => g.id === groupId);
            if (group) {
                group.links.push({ id: linkIdCounter++, name: '', url: '' });
                renderGroups();
                updatePreview();
                announce(`New link added to "${group.name}"`);
            }
        }

        // Remove a link from a group
        function removeLinkFromGroup(groupId, linkId) {
            const group = groups.find(g => g.id === groupId);
            if (group) {
                const link = group.links.find(l => l.id === linkId);
                const linkName = link && link.name ? link.name : 'Link';
                if (!confirm(`Delete "${linkName}"?`)) return;
                group.links = group.links.filter(l => l.id !== linkId);
                renderGroups();
                updatePreview();
                announce(`"${linkName}" removed from "${group.name}"`);
            }
        }

        // Drag and drop state
        let draggedGroupId = null;
        let draggedLinkId = null;
        let draggedLinkGroupId = null;

        // Group drag handlers
        function handleGroupDragStart(e, groupId) {
            draggedGroupId = groupId;
            e.target.closest('.group-card').classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleGroupDragEnd(e) {
            draggedGroupId = null;
            document.querySelectorAll('.group-card').forEach(el => {
                el.classList.remove('dragging', 'drag-over');
            });
        }

        function handleGroupDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            const card = e.target.closest('.group-card');
            if (card && draggedGroupId !== null) {
                card.classList.add('drag-over');
            }
        }

        function handleGroupDragLeave(e) {
            const card = e.target.closest('.group-card');
            if (card) {
                card.classList.remove('drag-over');
            }
        }

        function handleGroupDrop(e, targetGroupId) {
            e.preventDefault();
            if (draggedGroupId === null || draggedGroupId === targetGroupId) return;

            const fromIndex = groups.findIndex(g => g.id === draggedGroupId);
            const toIndex = groups.findIndex(g => g.id === targetGroupId);

            if (fromIndex !== -1 && toIndex !== -1) {
                const [movedGroup] = groups.splice(fromIndex, 1);
                groups.splice(toIndex, 0, movedGroup);
                renderGroups();
                updatePreview();
                announce('Group reordered');
            }
        }

        // Link drag handlers
        function handleLinkDragStart(e, groupId, linkId) {
            draggedLinkId = linkId;
            draggedLinkGroupId = groupId;
            e.target.closest('.link-row').classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleLinkDragEnd(e) {
            draggedLinkId = null;
            draggedLinkGroupId = null;
            document.querySelectorAll('.link-row').forEach(el => {
                el.classList.remove('dragging', 'drag-over');
            });
        }

        function handleLinkDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            const row = e.target.closest('.link-row');
            if (row && draggedLinkId !== null) {
                row.classList.add('drag-over');
            }
        }

        function handleLinkDragLeave(e) {
            const row = e.target.closest('.link-row');
            if (row) {
                row.classList.remove('drag-over');
            }
        }

        function handleLinkDrop(e, targetGroupId, targetLinkId) {
            e.preventDefault();
            if (draggedLinkId === null) return;

            const sourceGroup = groups.find(g => g.id === draggedLinkGroupId);
            const targetGroup = groups.find(g => g.id === targetGroupId);

            if (!sourceGroup || !targetGroup) return;

            const fromIndex = sourceGroup.links.findIndex(l => l.id === draggedLinkId);
            const toIndex = targetGroup.links.findIndex(l => l.id === targetLinkId);

            if (fromIndex === -1) return;

            // Remove from source
            const [movedLink] = sourceGroup.links.splice(fromIndex, 1);

            // Add to target
            if (toIndex === -1) {
                targetGroup.links.push(movedLink);
            } else {
                targetGroup.links.splice(toIndex, 0, movedLink);
            }

            renderGroups();
            updatePreview();
            announce('Link reordered');
        }

        // Update group name
        function updateGroupName(groupId, name) {
            const group = groups.find(g => g.id === groupId);
            if (group) {
                group.name = name;
                updatePreview();
            }
        }

        // Update link in group
        function updateGroupLink(groupId, linkId, field, value) {
            const group = groups.find(g => g.id === groupId);
            if (group) {
                const link = group.links.find(l => l.id === linkId);
                if (link) {
                    link[field] = value;
                    updatePreview();
                }
            }
        }

        // Add ungrouped link
        function addUngroupedLink() {
            ungroupedLinks.push({ id: linkIdCounter++, name: '', url: '' });
            renderUngroupedLinks();
            updatePreview();
            announce('New ungrouped link added');
        }

        // Remove ungrouped link
        function removeUngroupedLink(linkId) {
            const link = ungroupedLinks.find(l => l.id === linkId);
            const linkName = link && link.name ? link.name : 'Link';
            if (!confirm(`Delete "${linkName}"?`)) return;
            ungroupedLinks = ungroupedLinks.filter(l => l.id !== linkId);
            renderUngroupedLinks();
            updatePreview();
            announce(`"${linkName}" removed`);
        }

        // Update ungrouped link
        function updateUngroupedLink(linkId, field, value) {
            const link = ungroupedLinks.find(l => l.id === linkId);
            if (link) {
                link[field] = value;
                updatePreview();
            }
        }

        // Render groups to DOM
        function renderGroups() {
            const container = document.getElementById('groupsContainer');

            if (groups.length === 0) {
                container.innerHTML = '<p class="empty-message">No groups added yet. Click "Add Group" to create one.</p>';
                return;
            }

            container.innerHTML = groups.map((group, groupIndex) => `
                <fieldset class="group-card" data-group-id="${group.id}" aria-label="Link group ${groupIndex + 1}"
                          draggable="true"
                          ondragstart="handleGroupDragStart(event, ${group.id})"
                          ondragend="handleGroupDragEnd(event)"
                          ondragover="handleGroupDragOver(event)"
                          ondragleave="handleGroupDragLeave(event)"
                          ondrop="handleGroupDrop(event, ${group.id})">
                    <div class="group-header">
                        <span class="drag-handle" title="Drag to reorder">⋮⋮</span>
                        <label for="group-name-${group.id}" class="visually-hidden">Group ${groupIndex + 1} name</label>
                        <input type="text" id="group-name-${group.id}" value="${escapeHtml(group.name)}"
                               placeholder="Group name"
                               aria-label="Group name"
                               onchange="updateGroupName(${group.id}, this.value)">
                        <button type="button" class="btn btn-danger btn-sm" onclick="removeGroup(${group.id})" aria-label="Remove group ${escapeHtml(group.name) || groupIndex + 1}">Remove</button>
                    </div>
                    <div class="group-icon-row">
                        <label for="group-icon-${group.id}" class="group-icon-label">Icon:</label>
                        <input type="url" id="group-icon-${group.id}" value="${escapeHtml(group.icon || '')}"
                               placeholder="Icon URL (optional)"
                               aria-label="Group icon URL"
                               onchange="updateGroupIcon(${group.id}, this.value)">
                        <label for="group-icon-upload-${group.id}" class="btn btn-secondary btn-sm upload-btn" title="Upload SVG">
                            SVG
                            <input type="file" id="group-icon-upload-${group.id}" accept=".svg,image/svg+xml" onchange="handleGroupIconUpload(${group.id}, this)" class="visually-hidden">
                        </label>
                        <button type="button" class="btn btn-sm" onclick="clearGroupIcon(${group.id})" aria-label="Clear icon" title="Clear">✕</button>
                    </div>
                    <div class="group-links" role="list" aria-label="Links in ${escapeHtml(group.name) || 'this group'}">
                        ${group.links.length === 0 ? '<p class="empty-message" role="listitem">No links in this group</p>' : ''}
                        ${group.links.map((link, linkIndex) => `
                            <div class="link-row" role="listitem"
                                 draggable="true"
                                 ondragstart="handleLinkDragStart(event, ${group.id}, ${link.id})"
                                 ondragend="handleLinkDragEnd(event)"
                                 ondragover="handleLinkDragOver(event)"
                                 ondragleave="handleLinkDragLeave(event)"
                                 ondrop="handleLinkDrop(event, ${group.id}, ${link.id})">
                                <span class="drag-handle" title="Drag to reorder">⋮</span>
                                <label for="link-name-${group.id}-${link.id}" class="visually-hidden">Link ${linkIndex + 1} display name</label>
                                <input type="text" id="link-name-${group.id}-${link.id}" value="${escapeHtml(link.name)}"
                                       placeholder="Link name"
                                       aria-label="Link display name"
                                       onchange="updateGroupLink(${group.id}, ${link.id}, 'name', this.value)">
                                <label for="link-url-${group.id}-${link.id}" class="visually-hidden">Link ${linkIndex + 1} URL</label>
                                <input type="url" id="link-url-${group.id}-${link.id}" value="${escapeHtml(link.url)}"
                                       placeholder="https://example.com"
                                       aria-label="Link URL"
                                       onchange="updateGroupLink(${group.id}, ${link.id}, 'url', this.value)"
                                       onblur="validateUrlInput(this)">
                                <select class="windows-app-select" aria-label="Quick add Windows app" onchange="selectWindowsApp(${group.id}, ${link.id}, this)">
                                    ${getWindowsAppOptionsHTML()}
                                </select>
                                <button type="button" class="btn btn-danger btn-sm" onclick="removeLinkFromGroup(${group.id}, ${link.id})" aria-label="Remove link ${escapeHtml(link.name) || linkIndex + 1}">
                                    <span aria-hidden="true">X</span>
                                    <span class="visually-hidden">Remove</span>
                                </button>
                            </div>
                        `).join('')}
                        <button type="button" class="btn btn-secondary btn-sm" onclick="addLinkToGroup(${group.id})" aria-label="Add link to ${escapeHtml(group.name) || 'this group'}">+ Add Link</button>
                    </div>
                </fieldset>
            `).join('');
        }

        // Render ungrouped links
        function renderUngroupedLinks() {
            const container = document.getElementById('ungroupedLinksContainer');

            if (ungroupedLinks.length === 0) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = `<div role="list" aria-label="Ungrouped links">` + ungroupedLinks.map((link, linkIndex) => `
                <div class="link-row" style="margin-bottom: 0.75rem;" role="listitem">
                    <label for="ungrouped-name-${link.id}" class="visually-hidden">Ungrouped link ${linkIndex + 1} display name</label>
                    <input type="text" id="ungrouped-name-${link.id}" value="${escapeHtml(link.name)}"
                           placeholder="Link name"
                           aria-label="Link display name"
                           onchange="updateUngroupedLink(${link.id}, 'name', this.value)">
                    <label for="ungrouped-url-${link.id}" class="visually-hidden">Ungrouped link ${linkIndex + 1} URL</label>
                    <input type="url" id="ungrouped-url-${link.id}" value="${escapeHtml(link.url)}"
                           placeholder="https://example.com"
                           aria-label="Link URL"
                           onchange="updateUngroupedLink(${link.id}, 'url', this.value)"
                           onblur="validateUrlInput(this)">
                    <select class="windows-app-select" aria-label="Quick add Windows app" onchange="selectWindowsAppUngrouped(${link.id}, this)">
                        ${getWindowsAppOptionsHTML()}
                    </select>
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeUngroupedLink(${link.id})" aria-label="Remove link ${escapeHtml(link.name) || linkIndex + 1}">
                        <span aria-hidden="true">X</span>
                        <span class="visually-hidden">Remove</span>
                    </button>
                </div>
            `).join('') + `</div>`;
        }

        // Escape HTML for safe insertion
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }

        // Generate the HTML content
        function generateHTML(useComputerNameVariable = false) {
            const pageTitle = document.getElementById('pageTitle').value || 'Landing Page';
            const greeting = document.getElementById('greeting').value || 'Welcome';
            const showComputerName = document.getElementById('showComputerName').checked;
            const computerNamePosition = document.getElementById('computerNamePosition').value;
            const showDateTime = document.getElementById('showDateTime').checked;
            const dateTimeFormat = document.getElementById('dateTimeFormat').value;
            const dateTimePosition = document.getElementById('dateTimePosition').value;
            const topLogoUrl = document.getElementById('topLogoUrl').value.trim();
            const sideLogoUrl = document.getElementById('sideLogoUrl').value.trim();
            const sideLogoPosition = document.getElementById('sideLogoPosition').value;
            const showFooter = document.getElementById('showFooter').checked;
            const footerText = document.getElementById('footerText').value || '';
            const colors = getActiveColors();

            const computerNameDisplay = useComputerNameVariable ? '$computerName' : 'COMPUTER-NAME';

            // Build links HTML
            let linksHTML = '';

            // Add grouped links
            const validGroups = groups.filter(g => g.name && g.links.some(l => l.name && l.url));
            if (validGroups.length > 0) {
                linksHTML += validGroups.map(group => {
                    const validLinks = group.links.filter(l => l.name && l.url);
                    if (validLinks.length === 0) return '';

                    const groupId = group.name.toLowerCase().replace(/[^a-z0-9]+/g, '-');
                    const groupIconHtml = group.icon ? `<img class="group-icon" src="${escapeHtml(group.icon)}" alt="">` : '';
                    return `
            <section class="link-group" aria-labelledby="${groupId}-heading">
                <div class="group-heading-row">
                    ${groupIconHtml}<h2 id="${groupId}-heading" class="group-heading">${escapeHtml(group.name)}</h2>
                </div>
                <ul class="links-list">
                    ${validLinks.map(link => `
                    <li><a href="${escapeHtml(link.url)}" class="link-button">${escapeHtml(link.name)}</a></li>`).join('')}
                </ul>
            </section>`;
                }).join('');
            }

            // Add ungrouped links
            const validUngrouped = ungroupedLinks.filter(l => l.name && l.url);
            if (validUngrouped.length > 0) {
                linksHTML += `
            <section class="link-group" aria-labelledby="links-heading">
                <div class="group-heading-row">
                    <h2 id="links-heading" class="group-heading">Quick Links</h2>
                </div>
                <ul class="links-list">
                    ${validUngrouped.map(link => `
                    <li><a href="${escapeHtml(link.url)}" class="link-button">${escapeHtml(link.name)}</a></li>`).join('')}
                </ul>
            </section>`;
            }

            // If no links at all, show placeholder
            if (!linksHTML) {
                linksHTML = `
            <p style="color: rgba(255,255,255,0.7); font-style: italic;">No links configured</p>`;
            }

            const topLogoHTML = topLogoUrl ? `<img class="top-logo" src="${escapeHtml(topLogoUrl)}" alt="Logo">` : '';
            const sideLogoHTML = sideLogoUrl ? `<img class="side-logo" src="${escapeHtml(sideLogoUrl)}" alt="">` : '';

            // Build welcome header with proper structure
            let welcomeHeader = '';
            if (topLogoUrl) {
                welcomeHeader += `
        <div class="top-logo-container">
            ${topLogoHTML}
        </div>`;
            }

            if (sideLogoUrl) {
                const logoFirst = sideLogoPosition === 'left';
                welcomeHeader += `
        <div class="greeting-row${sideLogoPosition === 'right' ? ' logo-right' : ''}">
            ${logoFirst ? sideLogoHTML : ''}<h1>${escapeHtml(greeting)}</h1>${!logoFirst ? sideLogoHTML : ''}
        </div>`;
            } else {
                welcomeHeader += `
        <h1>${escapeHtml(greeting)}</h1>`;
            }

            // Build configuration object for import/export
            const config = {
                version: '1.0',
                generator: 'StartPage Studio',
                settings: {
                    pageTitle,
                    greeting,
                    showComputerName,
                    computerNamePosition,
                    showDateTime,
                    dateTimeFormat,
                    dateTimePosition,
                    topLogoUrl,
                    sideLogoUrl,
                    sideLogoPosition,
                    showFooter,
                    footerText
                },
                theme: {
                    selectedTheme,
                    customColors: selectedTheme === 'custom' ? customColors : null,
                    primary: colors.primary,
                    accent: colors.accent
                },
                groups: groups.map(g => ({
                    name: g.name,
                    icon: g.icon || '',
                    links: g.links.map(l => ({ name: l.name, url: l.url }))
                })),
                ungroupedLinks: ungroupedLinks.map(l => ({ name: l.name, url: l.url }))
            };
            const configJson = JSON.stringify(config);

            return `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="StartPage Studio">
    <meta name="description" content="Quick links landing page">
    <title>${escapeHtml(pageTitle)}</title>
    <style>
        :root {
            --primary-color: ${colors.primary};
            --accent-color: ${colors.accent};
            --white: #FFFFFF;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--primary-color);
            color: var(--white);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .skip-link {
            position: absolute;
            top: -40px;
            left: 0;
            background: var(--accent-color);
            color: var(--primary-color);
            padding: 8px 16px;
            z-index: 100;
            font-weight: bold;
            text-decoration: none;
        }

        .skip-link:focus {
            top: 0;
        }

        .computer-name {
            position: fixed;
            background-color: var(--white);
            color: var(--primary-color);
            padding: 0.5rem 1rem;
            border-radius: 4px;
            font-size: 0.875rem;
            font-weight: 600;
            z-index: 50;
        }

        .computer-name.top-right {
            top: 1rem;
            right: 1rem;
        }

        .computer-name.top-center {
            top: 1rem;
            left: 50%;
            transform: translateX(-50%);
        }

        .computer-name.top-left {
            top: 1rem;
            left: 1rem;
        }

        .computer-name.bottom-right {
            bottom: 1rem;
            right: 1rem;
        }

        .computer-name.bottom-center {
            bottom: 1rem;
            left: 50%;
            transform: translateX(-50%);
        }

        .computer-name.bottom-left {
            bottom: 1rem;
            left: 1rem;
        }

        .date-time {
            position: fixed;
            background-color: var(--white);
            color: var(--primary-color);
            padding: 0.5rem 1rem;
            border-radius: 4px;
            font-size: 0.875rem;
            font-weight: 600;
            font-family: 'Consolas', 'Monaco', monospace;
            z-index: 50;
        }

        .date-time.top-right {
            top: 1rem;
            right: 1rem;
        }

        .date-time.top-center {
            top: 1rem;
            left: 50%;
            transform: translateX(-50%);
        }

        .date-time.top-left {
            top: 1rem;
            left: 1rem;
        }

        .date-time.bottom-right {
            bottom: 1rem;
            right: 1rem;
        }

        .date-time.bottom-center {
            bottom: 1rem;
            left: 50%;
            transform: translateX(-50%);
        }

        .date-time.bottom-left {
            bottom: 1rem;
            left: 1rem;
        }

        .footer-datetime {
            font-family: 'Consolas', 'Monaco', monospace;
            margin-top: 0.5rem;
        }

        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 2rem;
        }

        .top-logo-container {
            display: flex;
            justify-content: center;
            margin-bottom: 1.5rem;
        }

        .top-logo {
            width: 100px;
            height: auto;
        }

        .greeting-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .greeting-row.logo-right {
            flex-direction: row;
        }

        .side-logo {
            width: 56px;
            height: auto;
            flex-shrink: 0;
        }

        h1 {
            font-size: 2rem;
            color: var(--white);
            margin: 0;
        }

        .links-container {
            width: 100%;
            max-width: 1400px;
            padding: 0 1rem;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1.5rem;
        }

        .link-group {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1.25rem;
        }

        .group-heading-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        }

        .group-icon {
            width: 24px;
            height: 24px;
            flex-shrink: 0;
        }

        .group-heading {
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--accent-color);
            margin: 0;
        }

        .links-list {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            padding: 0;
            margin: 0;
        }

        .links-list li {
            display: flex;
        }

        .link-button {
            display: flex;
            align-items: center;
            justify-content: center;
            flex: 1;
            background-color: var(--accent-color);
            color: var(--primary-color);
            text-decoration: none;
            padding: 1rem 1.5rem;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 8px;
            border: 3px solid var(--accent-color);
            transition: background-color 0.2s ease, color 0.2s ease, transform 0.1s ease;
            min-height: 44px;
            min-width: 44px;
        }

        .link-button:hover,
        .link-button:focus {
            background-color: var(--white);
            color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 4px var(--accent-color);
            transform: scale(1.02);
        }

        .link-button:active {
            transform: scale(0.98);
        }

        footer {
            padding: 1rem;
            text-align: center;
            font-size: 0.75rem;
            color: var(--white);
            opacity: 0.7;
        }

        .link-button:focus-visible {
            outline: 3px solid var(--white);
            outline-offset: 2px;
        }

        .skip-link:focus-visible {
            outline: 3px solid var(--primary-color);
            outline-offset: 2px;
        }

        @media (prefers-reduced-motion: reduce) {
            .link-button {
                transition: none;
            }
        }

        @media (prefers-contrast: high) {
            .link-button {
                border: 3px solid var(--white);
            }
        }

        @media (max-width: 600px) {
            .links-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <a href="#main-content" class="skip-link">Skip to main content</a>
${showComputerName ? `
    <div class="computer-name ${computerNamePosition}" role="status" aria-label="Computer name: ${computerNameDisplay}">
        ${computerNameDisplay}
    </div>
` : ''}
${showDateTime && dateTimePosition !== 'footer' ? `
    <div class="date-time ${dateTimePosition}" role="timer" aria-label="Current date and time" id="datetime-display">
        --
    </div>
` : ''}
    <main id="main-content" role="main">
        ${welcomeHeader}

        <nav class="links-container" aria-label="Quick links">
${linksHTML}
        </nav>
    </main>
${(showFooter && footerText) || (showDateTime && dateTimePosition === 'footer') ? `
    <footer role="contentinfo">
        ${showFooter && footerText ? `<p>${escapeHtml(footerText)}</p>` : ''}
        ${showDateTime && dateTimePosition === 'footer' ? `<p class="footer-datetime" id="datetime-display">--</p>` : ''}
    </footer>
` : ''}
${showDateTime ? `
    <script>
        function updateDateTime() {
            const now = new Date();
            const format = '${dateTimeFormat}';
            let display = '';

            if (format === 'date' || format === 'both') {
                display += now.toISOString().split('T')[0];
            }
            if (format === 'both') {
                display += ' ';
            }
            if (format === 'time' || format === 'both') {
                display += now.toTimeString().split(' ')[0];
            }

            document.getElementById('datetime-display').textContent = display;
        }
        updateDateTime();
        setInterval(updateDateTime, 1000);
    <` + `/script>
` : ''}
<!-- StartPage Studio Config: ${configJson} -->
</body>
</html>`;
        }

        // Update date/time position options to exclude computer name position
        function updateDateTimePositionOptions() {
            const showComputerName = document.getElementById('showComputerName').checked;
            const computerNamePosition = document.getElementById('computerNamePosition').value;
            const dateTimeSelect = document.getElementById('dateTimePosition');
            const currentValue = dateTimeSelect.value;

            const allPositions = [
                { value: 'top-right', label: 'Top Right' },
                { value: 'top-center', label: 'Top Center' },
                { value: 'top-left', label: 'Top Left' },
                { value: 'bottom-right', label: 'Bottom Right' },
                { value: 'bottom-center', label: 'Bottom Center' },
                { value: 'bottom-left', label: 'Bottom Left' },
                { value: 'footer', label: 'In Footer' }
            ];

            // Filter out the computer name position if computer name is shown
            const availablePositions = showComputerName
                ? allPositions.filter(p => p.value !== computerNamePosition)
                : allPositions;

            // Rebuild options
            dateTimeSelect.innerHTML = availablePositions.map(p =>
                `<option value="${p.value}">${p.label}</option>`
            ).join('');

            // Try to restore previous selection, or pick first available
            if (availablePositions.some(p => p.value === currentValue)) {
                dateTimeSelect.value = currentValue;
            } else {
                dateTimeSelect.value = availablePositions[0].value;
            }
        }

        // Update the preview iframe
        function updatePreview() {
            const iframe = document.getElementById('previewFrame');
            const html = generateHTML(false);
            iframe.srcdoc = html;

            // Toggle footer text visibility
            const showFooter = document.getElementById('showFooter').checked;
            document.getElementById('footerTextGroup').style.display = showFooter ? 'block' : 'none';

            // Toggle computer name position visibility
            const showComputerName = document.getElementById('showComputerName').checked;
            document.getElementById('computerNamePositionGroup').style.display = showComputerName ? 'block' : 'none';

            // Toggle date/time options visibility
            const showDateTime = document.getElementById('showDateTime').checked;
            document.getElementById('dateTimeOptionsGroup').style.display = showDateTime ? 'block' : 'none';
            document.getElementById('dateTimePositionGroup').style.display = showDateTime ? 'block' : 'none';

            // Update date/time position options when computer name settings change
            if (showDateTime) {
                updateDateTimePositionOptions();
            }

            // Toggle side logo position visibility
            const sideLogoUrl = document.getElementById('sideLogoUrl').value.trim();
            document.getElementById('sideLogoPositionGroup').style.display = sideLogoUrl ? 'block' : 'none';

            // Save state to localStorage
            saveState();
        }

        // Generate PowerShell script
        function generatePowerShellScript() {
            const htmlContent = generateHTML(true);
            // Escape for PowerShell here-string (just need to escape @" and "@ if they appear)
            const escapedHtml = htmlContent.replace(/"@/g, '`"@').replace(/@"/g, '@`"');

            // Get destination path and parse folder
            const destinationPath = document.getElementById('destinationPath').value || 'C:\\ProgramData\\StartPage\\index.html';
            const escapedDestPath = destinationPath.replace(/\\/g, '\\\\');
            const folderPath = destinationPath.substring(0, destinationPath.lastIndexOf('\\')) || 'C:\\ProgramData\\StartPage';
            const escapedFolderPath = folderPath.replace(/\\/g, '\\\\');

            return `# Generate-StartPage.ps1
# Generated by StartPage Studio
# Author: Joshua Walderbach

$computerName = $env:COMPUTERNAME
$outputFolder = "${escapedFolderPath}"
$outputPath = "${escapedDestPath}"
$logFolder = "${escapedFolderPath}\\Logs"
$timestamp = Get-Date -Format 'yyyy-MM-ddTHH-mm-ss'
$logFile = Join-Path $logFolder "Generate-StartPage_$timestamp.log"

# Create directories if they don't exist
if (-not (Test-Path $outputFolder)) {
    New-Item -ItemType Directory -Path $outputFolder -Force | Out-Null
}
if (-not (Test-Path $logFolder)) {
    New-Item -ItemType Directory -Path $logFolder -Force | Out-Null
}

function Write-Log {
    param([string]$Message)
    $logLine = "$(Get-Date -Format 'yyyy-MM-ddTHH:mm:ss') $Message"
    Write-Host $logLine
    Add-Content -Path $logFile -Value $logLine -ErrorAction SilentlyContinue
}

Write-Log "Script started"
Write-Log "Computer name: $computerName"
Write-Log "Output path: $outputPath"

$htmlContent = @"
${escapedHtml}
"@

# Write the HTML file
$htmlContent | Out-File -FilePath $outputPath -Encoding UTF8 -Force

Write-Log "Landing page generated successfully"
Write-Log "Log file: $logFile"
`;
        }

        // Show instruction modal
        function showInstructionModal() {
            const showComputerName = document.getElementById('showComputerName').checked;
            const destinationPath = document.getElementById('destinationPath').value || 'C:\\ProgramData\\StartPage\\index.html';

            let computerNameNote = '';
            if (showComputerName) {
                computerNameNote = '<p><strong>Note:</strong> The computer name will be automatically detected when the script runs on the target machine.</p>';
            }

            const modalBody = document.getElementById('modalBody');
            modalBody.innerHTML = `
                <h3>Next Steps</h3>
                <ol>
                    <li>Copy <code>Generate-StartPage.ps1</code> to your target computer</li>
                    <li>Open <strong>Command Prompt</strong> or <strong>PowerShell</strong> as Administrator</li>
                    <li>Run the script:
                        <div class="code-block">powershell -ExecutionPolicy Bypass -File "Generate-StartPage.ps1"</div>
                    </li>
                    <li>Open the landing page in your browser:
                        <div class="code-block">${escapeHtml(destinationPath)}</div>
                    </li>
                </ol>
                ${computerNameNote}
                <h3>Setting as Browser Homepage</h3>
                <p>To use this as your browser's start page, set the homepage URL to:</p>
                <div class="code-block">file:///${escapeHtml(destinationPath.replace(/\\/g, '/'))}</div>
            `;

            document.getElementById('instructionModal').classList.add('visible');
            document.querySelector('.modal-close').focus();
        }

        // Close modal
        function closeModal() {
            document.getElementById('instructionModal').classList.remove('visible');
        }

        // Close modal on Escape key or click outside
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModal();
            }
        });

        document.getElementById('instructionModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        // Download PowerShell script
        function downloadScript() {
            if (!validateAllUrls()) return;
            const script = generatePowerShellScript();
            const blob = new Blob([script], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'Generate-StartPage.ps1';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            announce('PowerShell script downloaded');

            // Show instruction modal
            showInstructionModal();
        }

        // Download HTML only
        function downloadHTML() {
            if (!validateAllUrls()) return;
            const html = generateHTML(false);
            const blob = new Blob([html], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'index.html';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            announce('HTML file downloaded');
        }

        // Import existing start page
        function importStartPage(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const html = e.target.result;

                // Check for StartPage Studio signature
                if (!html.includes('<meta name="generator" content="StartPage Studio">')) {
                    alert('This file was not created by StartPage Studio.\n\nOnly HTML files generated by this tool can be imported.');
                    input.value = '';
                    return;
                }

                // Extract config from comment
                const configMatch = html.match(/<!-- StartPage Studio Config: (.+?) -->/);
                if (!configMatch) {
                    alert('Could not find configuration data in this file.\n\nThe file may have been modified or is from an older version.');
                    input.value = '';
                    return;
                }

                try {
                    const config = JSON.parse(configMatch[1]);
                    applyImportedConfig(config);
                    announce('Start page imported successfully');
                    alert('Start page imported successfully!\n\nYou can now edit and re-export it.');
                } catch (err) {
                    alert('Error parsing configuration data.\n\nThe file may be corrupted.');
                    console.error('Import error:', err);
                }

                input.value = ''; // Reset file input
            };
            reader.readAsText(file);
        }

        // Apply imported configuration
        function applyImportedConfig(config) {
            // Apply settings
            if (config.settings) {
                document.getElementById('pageTitle').value = config.settings.pageTitle || 'Quick Links';
                document.getElementById('greeting').value = config.settings.greeting || 'Welcome';
                document.getElementById('showComputerName').checked = config.settings.showComputerName !== false;
                document.getElementById('computerNamePosition').value = config.settings.computerNamePosition || 'top-right';
                document.getElementById('showDateTime').checked = config.settings.showDateTime || false;
                document.getElementById('dateTimeFormat').value = config.settings.dateTimeFormat || 'both';
                document.getElementById('dateTimePosition').value = config.settings.dateTimePosition || 'top-left';
                document.getElementById('topLogoUrl').value = config.settings.topLogoUrl || '';
                document.getElementById('sideLogoUrl').value = config.settings.sideLogoUrl || '';
                document.getElementById('sideLogoPosition').value = config.settings.sideLogoPosition || 'left';
                document.getElementById('showFooter').checked = config.settings.showFooter !== false;
                document.getElementById('footerText').value = config.settings.footerText || '';
            }

            // Apply theme
            if (config.theme) {
                selectedTheme = config.theme.selectedTheme || 'monochrome';
                if (config.theme.customColors) {
                    customColors = config.theme.customColors;
                    document.getElementById('customPrimary').value = customColors.primary;
                    document.getElementById('customPrimaryPicker').value = customColors.primary;
                    document.getElementById('customAccent').value = customColors.accent;
                    document.getElementById('customAccentPicker').value = customColors.accent;
                }
                renderThemeSwatches();
            }

            // Apply groups
            if (config.groups) {
                groups = config.groups.map(g => ({
                    id: groupIdCounter++,
                    name: g.name,
                    icon: g.icon || '',
                    links: g.links.map(l => ({
                        id: linkIdCounter++,
                        name: l.name,
                        url: l.url
                    }))
                }));
                renderGroups();
            }

            // Apply ungrouped links
            if (config.ungroupedLinks) {
                ungroupedLinks = config.ungroupedLinks.map(l => ({
                    id: linkIdCounter++,
                    name: l.name,
                    url: l.url
                }));
                renderUngroupedLinks();
            }

            updatePreview();
            saveState();
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
